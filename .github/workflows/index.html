<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Senserbot Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/eventemitter2/lib/eventemitter2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/roslib/build/roslib.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/easeljs/lib/easeljs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ros2d/build/ros2d.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three/build/three.min.js"></script>
  <style>
    :root {
      --bg: #0a0e14;
      --panel: #0f1520;
      --border: #1e3a5f;
      --accent: #00d4ff;
      --accent2: #ff6b2b;
      --green: #00ff9d;
      --warn: #ffcc00;
      --text: #c8d8e8;
      --dim: #4a6080;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Rajdhani', sans-serif;
      font-size: 15px;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Grid background */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image:
        linear-gradient(rgba(0,212,255,0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0,212,255,0.03) 1px, transparent 1px);
      background-size: 40px 40px;
      pointer-events: none;
      z-index: 0;
    }

    header {
      position: relative;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 24px;
      border-bottom: 1px solid var(--border);
      background: rgba(15,21,32,0.95);
      backdrop-filter: blur(8px);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-icon {
      width: 36px; height: 36px;
      border: 2px solid var(--accent);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      position: relative;
    }

    .logo-icon::after {
      content: '';
      width: 12px; height: 12px;
      background: var(--accent);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(0.8); }
    }

    .logo-text { font-size: 22px; font-weight: 700; letter-spacing: 3px; color: var(--accent); }
    .logo-sub { font-family: 'Share Tech Mono', monospace; font-size: 10px; color: var(--dim); letter-spacing: 2px; }

    .status-bar {
      display: flex; gap: 20px; align-items: center;
      font-family: 'Share Tech Mono', monospace; font-size: 11px;
    }

    .status-dot {
      display: flex; align-items: center; gap: 6px;
    }

    .dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: #ff3333;
      box-shadow: 0 0 6px #ff3333;
    }
    .dot.connected { background: var(--green); box-shadow: 0 0 6px var(--green); }
    .dot.warning { background: var(--warn); box-shadow: 0 0 6px var(--warn); }

    .main-grid {
      position: relative;
      z-index: 1;
      display: grid;
      grid-template-columns: 1fr 420px 260px;
      grid-template-rows: auto auto;
      gap: 12px;
      padding: 12px;
      height: calc(100vh - 61px);
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 4px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 14px;
      border-bottom: 1px solid var(--border);
      background: rgba(0,212,255,0.04);
    }

    .panel-title {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--accent);
      font-family: 'Share Tech Mono', monospace;
    }

    .panel-tag {
      font-family: 'Share Tech Mono', monospace;
      font-size: 9px;
      color: var(--dim);
      letter-spacing: 1px;
    }

    /* MAP PANEL */
    .map-panel {
      grid-column: 1;
      grid-row: 1 / 3;
    }

    #nav2dmap {
      flex: 1;
      width: 100%;
      cursor: crosshair;
      background: #060a0f;
    }

    .map-controls {
      display: flex;
      gap: 8px;
      padding: 8px 12px;
      border-top: 1px solid var(--border);
      background: rgba(0,0,0,0.3);
      flex-wrap: wrap;
      align-items: center;
    }

    .mode-btn {
      font-family: 'Share Tech Mono', monospace;
      font-size: 11px;
      padding: 5px 12px;
      border: 1px solid var(--dim);
      background: transparent;
      color: var(--dim);
      border-radius: 2px;
      cursor: pointer;
      letter-spacing: 1px;
      transition: all 0.15s;
    }

    .mode-btn:hover, .mode-btn.active {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(0,212,255,0.08);
    }

    .mode-btn.goal-active {
      border-color: var(--accent2);
      color: var(--accent2);
      background: rgba(255,107,43,0.1);
      animation: blink-border 1s infinite;
    }

    @keyframes blink-border {
      50% { border-color: transparent; }
    }

    #map-status {
      font-family: 'Share Tech Mono', monospace;
      font-size: 10px;
      color: var(--warn);
      flex: 1;
      text-align: right;
    }

    /* CAMERA PANEL */
    .camera-panel {
      grid-column: 2;
      grid-row: 1;
    }

    .camera-panel iframe {
      flex: 1;
      width: 100%;
      border: none;
      background: #000;
      min-height: 240px;
    }

    /* TELEMETRY PANEL */
    .telemetry-panel {
      grid-column: 3;
      grid-row: 1;
    }

    .telem-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1px;
      padding: 10px;
      flex: 1;
    }

    .telem-item {
      padding: 8px;
      border: 1px solid rgba(30,58,95,0.5);
      border-radius: 2px;
    }

    .telem-label {
      font-family: 'Share Tech Mono', monospace;
      font-size: 9px;
      color: var(--dim);
      letter-spacing: 1px;
      margin-bottom: 4px;
    }

    .telem-value {
      font-family: 'Share Tech Mono', monospace;
      font-size: 15px;
      color: var(--green);
      font-weight: bold;
    }

    /* TELEOP PANEL */
    .teleop-panel {
      grid-column: 2;
      grid-row: 2;
    }

    .teleop-inner {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 12px;
      gap: 20px;
    }

    .dpad {
      display: grid;
      grid-template-columns: repeat(3, 54px);
      grid-template-rows: repeat(3, 54px);
      gap: 4px;
    }

    .dpad-btn {
      background: rgba(0,212,255,0.06);
      border: 1px solid var(--border);
      color: var(--accent);
      font-size: 20px;
      border-radius: 4px;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.1s;
      user-select: none;
      touch-action: none;
    }

    .dpad-btn:active, .dpad-btn.pressed {
      background: rgba(0,212,255,0.2);
      border-color: var(--accent);
      box-shadow: 0 0 12px rgba(0,212,255,0.3);
    }

    .dpad-center {
      background: rgba(255,107,43,0.08);
      border-color: rgba(255,107,43,0.3);
      color: var(--accent2);
      font-size: 13px;
      font-family: 'Share Tech Mono', monospace;
      letter-spacing: 0;
    }

    .vel-display {
      font-family: 'Share Tech Mono', monospace;
      font-size: 11px;
      color: var(--dim);
      min-width: 110px;
    }

    .vel-display div { margin-bottom: 6px; }
    .vel-display span { color: var(--accent); }

    /* CONTROL PANEL */
    .control-panel {
      grid-column: 3;
      grid-row: 2;
    }

    .control-inner {
      flex: 1;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .ctrl-btn {
      font-family: 'Share Tech Mono', monospace;
      font-size: 11px;
      padding: 9px 12px;
      border-radius: 2px;
      cursor: pointer;
      letter-spacing: 1px;
      text-align: left;
      transition: all 0.15s;
      width: 100%;
    }

    .ctrl-btn-primary {
      background: rgba(0,212,255,0.08);
      border: 1px solid var(--accent);
      color: var(--accent);
    }
    .ctrl-btn-primary:hover {
      background: rgba(0,212,255,0.18);
      box-shadow: 0 0 10px rgba(0,212,255,0.2);
    }

    .ctrl-btn-warn {
      background: rgba(255,204,0,0.06);
      border: 1px solid var(--warn);
      color: var(--warn);
    }
    .ctrl-btn-warn:hover { background: rgba(255,204,0,0.14); }

    .ctrl-btn-danger {
      background: rgba(255,51,51,0.06);
      border: 1px solid #ff3333;
      color: #ff3333;
    }
    .ctrl-btn-danger:hover { background: rgba(255,51,51,0.14); }

    .ws-input-row {
      display: flex; gap: 4px; margin-top: 2px;
    }

    .ws-input {
      flex: 1;
      background: rgba(0,0,0,0.4);
      border: 1px solid var(--border);
      border-radius: 2px;
      color: var(--text);
      font-family: 'Share Tech Mono', monospace;
      font-size: 10px;
      padding: 5px 8px;
      outline: none;
    }
    .ws-input:focus { border-color: var(--accent); }

    .ws-connect-btn {
      background: rgba(0,255,157,0.08);
      border: 1px solid var(--green);
      color: var(--green);
      font-family: 'Share Tech Mono', monospace;
      font-size: 10px;
      padding: 5px 10px;
      border-radius: 2px;
      cursor: pointer;
      letter-spacing: 1px;
    }
    .ws-connect-btn:hover { background: rgba(0,255,157,0.16); }

    .section-label {
      font-family: 'Share Tech Mono', monospace;
      font-size: 9px;
      color: var(--dim);
      letter-spacing: 2px;
      text-transform: uppercase;
      border-bottom: 1px solid var(--border);
      padding-bottom: 4px;
      margin-bottom: 4px;
    }

    #log-box {
      font-family: 'Share Tech Mono', monospace;
      font-size: 10px;
      color: var(--dim);
      line-height: 1.6;
      max-height: 80px;
      overflow-y: auto;
      padding: 4px 0;
    }

    #log-box .log-ok { color: var(--green); }
    #log-box .log-warn { color: var(--warn); }
    #log-box .log-err { color: #ff3333; }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 4px; height: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
  </style>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-icon"></div>
    <div>
      <div class="logo-text">SENSERBOT</div>
      <div class="logo-sub">ROBOTNIK CONTROL INTERFACE</div>
    </div>
  </div>
  <div class="status-bar">
    <div class="status-dot"><div class="dot" id="ros-dot"></div><span id="ros-status">ROS DISCONNECTED</span></div>
    <div class="status-dot"><div class="dot warning" id="ext-dot"></div><span id="ext-status">EXT WS IDLE</span></div>
    <div style="color:var(--dim); font-family:'Share Tech Mono',monospace; font-size:11px;" id="clock"></div>
  </div>
</header>

<div class="main-grid">

  <!-- MAP -->
  <div class="panel map-panel">
    <div class="panel-header">
      <span class="panel-title">Navigation Map</span>
      <span class="panel-tag">/robot/map · /robot/amcl_pose</span>
    </div>
    <div id="nav2dmap" style="flex:1;"></div>
    <div class="map-controls">
      <button class="mode-btn active" id="btn-view" onclick="setMode('view')">VIEW</button>
      <button class="mode-btn" id="btn-goal" onclick="setMode('goal')">SET GOAL</button>
      <button class="mode-btn" id="btn-initpose" onclick="setMode('initpose')">SET INIT POSE</button>
      <span id="map-status">Click map in GOAL mode to navigate</span>
    </div>
  </div>

  <!-- CAMERA -->
  <div class="panel camera-panel">
    <div class="panel-header">
      <span class="panel-title">Front RGBD Camera</span>
      <span class="panel-tag">/robot/front_rgbd_camera/color</span>
    </div>
    <iframe
      src="http://localhost:8080/stream?topic=/robot/front_rgbd_camera/color/image_raw"
      title="Camera Feed">
    </iframe>
  </div>

  <!-- TELEMETRY -->
  <div class="panel telemetry-panel">
    <div class="panel-header">
      <span class="panel-title">Telemetry</span>
      <span class="panel-tag">/robot/robotnik_base_control/odom</span>
    </div>
    <div class="telem-grid">
      <div class="telem-item">
        <div class="telem-label">POS X</div>
        <div class="telem-value" id="t-x">—</div>
      </div>
      <div class="telem-item">
        <div class="telem-label">POS Y</div>
        <div class="telem-value" id="t-y">—</div>
      </div>
      <div class="telem-item">
        <div class="telem-label">LIN VEL</div>
        <div class="telem-value" id="t-linvel">—</div>
      </div>
      <div class="telem-item">
        <div class="telem-label">ANG VEL</div>
        <div class="telem-value" id="t-angvel">—</div>
      </div>
      <div class="telem-item" style="grid-column:1/-1;">
        <div class="telem-label">HEADING (W)</div>
        <div class="telem-value" id="t-theta">—</div>
      </div>
    </div>
  </div>

  <!-- TELEOP -->
  <div class="panel teleop-panel">
    <div class="panel-header">
      <span class="panel-title">Teleop</span>
      <span class="panel-tag">/robot/web_teleop/cmd_vel</span>
    </div>
    <div class="teleop-inner">
      <div class="dpad">
        <div></div>
        <button class="dpad-btn" id="btn-fwd" onmousedown="startMove(0.5,0)" onmouseup="stopMove" ontouchstart="startMove(0.5,0)" ontouchend="stopMove">▲</button>
        <div></div>
        <button class="dpad-btn" id="btn-left" onmousedown="startMove(0,0.6)" onmouseup="stopMove" ontouchstart="startMove(0,0.6)" ontouchend="stopMove">◄</button>
        <button class="dpad-btn dpad-center" id="btn-stop" onmousedown="stopMove">STOP</button>
        <button class="dpad-btn" id="btn-right" onmousedown="startMove(0,-0.6)" onmouseup="stopMove" ontouchstart="startMove(0,-0.6)" ontouchend="stopMove">►</button>
        <div></div>
        <button class="dpad-btn" id="btn-bwd" onmousedown="startMove(-0.5,0)" onmouseup="stopMove" ontouchstart="startMove(-0.5,0)" ontouchend="stopMove">▼</button>
        <div></div>
      </div>
      <div class="vel-display">
        <div>LINEAR<br><span id="v-lin">0.00</span> m/s</div>
        <div>ANGULAR<br><span id="v-ang">0.00</span> rad/s</div>
      </div>
    </div>
  </div>

  <!-- CONTROLS -->
  <div class="panel control-panel">
    <div class="panel-header">
      <span class="panel-title">Controls</span>
      <span class="panel-tag">NAV · POSE · WS</span>
    </div>
    <div class="control-inner">

      <div class="section-label">Localization</div>
      <button class="ctrl-btn ctrl-btn-primary" onclick="autoSetInitialPose()">⊕ AUTO SET INIT POSE</button>

      <div class="section-label">External WebSocket</div>
      <div class="ws-input-row">
        <input class="ws-input" id="ext-ws-url" type="text" value="ws://localhost:9091" placeholder="ws://host:port"/>
        <button class="ws-connect-btn" onclick="toggleExtWS()">CONNECT</button>
      </div>

      <div class="section-label">Log</div>
      <div id="log-box"></div>

    </div>
  </div>

</div>

<script>
  // ─── Clock ───────────────────────────────────────────────
  setInterval(() => {
    document.getElementById('clock').textContent = new Date().toLocaleTimeString('en-SG', {hour12:false});
  }, 1000);

  // ─── Logging ─────────────────────────────────────────────
  function log(msg, type='') {
    const box = document.getElementById('log-box');
    const el = document.createElement('div');
    el.className = type ? 'log-'+type : '';
    el.textContent = '> ' + msg;
    box.appendChild(el);
    box.scrollTop = box.scrollHeight;
    if (box.children.length > 30) box.removeChild(box.firstChild);
  }

  // ─── ROS Connection ──────────────────────────────────────
  const ROBOT_IP = 'localhost'; // Change to robot's IP if needed
  var ros = new ROSLIB.Ros({ url: 'ws://' + ROBOT_IP + ':9090' });

  ros.on('connection', () => {
    document.getElementById('ros-dot').className = 'dot connected';
    document.getElementById('ros-status').textContent = 'ROS CONNECTED';
    log('rosbridge connected', 'ok');
  });
  ros.on('error', (e) => {
    document.getElementById('ros-dot').className = 'dot';
    document.getElementById('ros-status').textContent = 'ROS ERROR';
    log('rosbridge error: ' + e, 'err');
  });
  ros.on('close', () => {
    document.getElementById('ros-dot').className = 'dot';
    document.getElementById('ros-status').textContent = 'ROS DISCONNECTED';
    log('rosbridge disconnected', 'warn');
  });

  // ─── Odometry ────────────────────────────────────────────
  var odomTopic = new ROSLIB.Topic({
    ros, name: '/robot/robotnik_base_control/odom',
    messageType: 'nav_msgs/Odometry'
  });
  odomTopic.subscribe(msg => {
    document.getElementById('t-x').textContent     = msg.pose.pose.position.x.toFixed(3);
    document.getElementById('t-y').textContent     = msg.pose.pose.position.y.toFixed(3);
    document.getElementById('t-theta').textContent = msg.pose.pose.orientation.w.toFixed(3);
    document.getElementById('t-linvel').textContent = msg.twist.twist.linear.x.toFixed(3);
    document.getElementById('t-angvel').textContent = msg.twist.twist.angular.z.toFixed(3);
  });

  // ─── Teleop ──────────────────────────────────────────────
  var cmdVelTopic = new ROSLIB.Topic({
    ros, name: '/robot/web_teleop/cmd_vel',
    messageType: 'geometry_msgs/Twist'
  });

  let moveInterval = null;

  function startMove(lin, ang) {
    if (moveInterval) clearInterval(moveInterval);
    document.getElementById('v-lin').textContent = lin.toFixed(2);
    document.getElementById('v-ang').textContent = ang.toFixed(2);
    moveInterval = setInterval(() => {
      cmdVelTopic.publish(new ROSLIB.Message({
        linear: {x: lin, y: 0, z: 0},
        angular: {x: 0, y: 0, z: ang}
      }));
    }, 50);
  }

  function stopMove() {
    if (moveInterval) clearInterval(moveInterval);
    moveInterval = null;
    cmdVelTopic.publish(new ROSLIB.Message({
      linear: {x:0,y:0,z:0}, angular: {x:0,y:0,z:0}
    }));
    document.getElementById('v-lin').textContent = '0.00';
    document.getElementById('v-ang').textContent = '0.00';
  }

  // ─── Navigation Goal ─────────────────────────────────────
  var goalTopic = new ROSLIB.Topic({
    ros, name: '/robot/move_base_flex/move_base_simple/goal',
    messageType: 'geometry_msgs/PoseStamped'
  });

  function publishGoal(x, y, theta) {
    var q = yawToQuaternion(theta);
    goalTopic.publish(new ROSLIB.Message({
      header: { frame_id: 'map' },
      pose: {
        position: { x, y, z: 0 },
        orientation: { x: 0, y: 0, z: q.z, w: q.w }
      }
    }));
    log('Goal sent → x:' + x.toFixed(2) + ' y:' + y.toFixed(2), 'ok');
  }

  // ─── Initial Pose ────────────────────────────────────────
  var initialPoseTopic = new ROSLIB.Topic({
    ros, name: '/robot/initialpose',
    messageType: 'geometry_msgs/PoseWithCovarianceStamped'
  });

  function publishInitialPose(x, y, theta) {
    var q = yawToQuaternion(theta);
    initialPoseTopic.publish(new ROSLIB.Message({
      header: { frame_id: 'map' },
      pose: {
        pose: {
          position: { x, y, z: 0 },
          orientation: { x: 0, y: 0, z: q.z, w: q.w }
        },
        covariance: [
          0.25,0,0,0,0,0,
          0,0.25,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0,
          0,0,0,0,0,0.068
        ]
      }
    }));
    log('Initial pose set → x:' + x.toFixed(2) + ' y:' + y.toFixed(2), 'ok');
  }

  // Auto set init pose from current AMCL estimate
  var amclPose = null;
  var amclTopic = new ROSLIB.Topic({
    ros, name: '/robot/amcl_pose',
    messageType: 'geometry_msgs/PoseWithCovarianceStamped'
  });
  amclTopic.subscribe(msg => { amclPose = msg; });

  function autoSetInitialPose() {
    if (amclPose) {
      var p = amclPose.pose.pose.position;
      var o = amclPose.pose.pose.orientation;
      initialPoseTopic.publish(new ROSLIB.Message({
        header: { frame_id: 'map' },
        pose: amclPose.pose
      }));
      log('Auto init pose from AMCL → x:' + p.x.toFixed(2) + ' y:' + p.y.toFixed(2), 'ok');
    } else {
      // Fallback: publish origin
      publishInitialPose(0, 0, 0);
      log('AMCL not yet received — using origin as initial pose', 'warn');
    }
  }

  // ─── Map Mode ────────────────────────────────────────────
  let mapMode = 'view'; // 'view' | 'goal' | 'initpose'
  let firstMapClick = null; // for heading determination

  function setMode(mode) {
    mapMode = mode;
    ['view','goal','initpose'].forEach(m => {
      document.getElementById('btn-'+m).classList.remove('active','goal-active');
    });
    if (mode === 'view') {
      document.getElementById('btn-view').classList.add('active');
      document.getElementById('map-status').textContent = 'Viewing map';
    } else if (mode === 'goal') {
      document.getElementById('btn-goal').classList.add('goal-active');
      document.getElementById('map-status').textContent = '1st click = position, 2nd click = heading';
    } else {
      document.getElementById('btn-initpose').classList.add('goal-active');
      document.getElementById('map-status').textContent = '1st click = position, 2nd click = heading';
    }
    firstMapClick = null;
  }

  // ─── Map Visualization ───────────────────────────────────
  var mapContainer = document.getElementById('nav2dmap');
  var viewer = new ROS2D.Viewer({
    divID: 'nav2dmap',
    width: mapContainer.offsetWidth || 600,
    height: mapContainer.offsetHeight || 500
  });

  var gridClient = new ROS2D.OccupancyGridClient({
    ros, rootObject: viewer.scene, continuous: true, topic: '/robot/map'
  });

  gridClient.on('change', function() {
    viewer.scaleToDimensions(gridClient.currentGrid.width, gridClient.currentGrid.height);
    viewer.shift(gridClient.currentGrid.pose.position.x, gridClient.currentGrid.pose.position.y);
  });

  // Robot arrow
  var robotArrow = new ROS2D.NavigationArrow({
    size: 0.4, strokeSize: 0.05, strokeStyle: '#00ff9d', pulse: false
  });
  viewer.scene.addChild(robotArrow);

  var robotPoseTopic2 = new ROSLIB.Topic({
    ros, name: '/robot/amcl_pose',
    messageType: 'geometry_msgs/PoseWithCovarianceStamped'
  });
  robotPoseTopic2.subscribe(function(msg) {
    var pose = msg.pose.pose;
    robotArrow.x = pose.position.x * viewer.scene.scaleX;
    robotArrow.y = -pose.position.y * viewer.scene.scaleY;
    var q = new THREE.Quaternion(
      pose.orientation.x, pose.orientation.y,
      pose.orientation.z, pose.orientation.w
    );
    var euler = new THREE.Euler().setFromQuaternion(q, 'ZYX');
    robotArrow.rotation = euler.z * (180 / Math.PI) - 90;
  });

  // Map click handler
  viewer.scene.canvas.addEventListener('click', function(e) {
    if (mapMode === 'view') return;
    var rect = viewer.scene.canvas.getBoundingClientRect();
    var canvasX = e.clientX - rect.left;
    var canvasY = e.clientY - rect.top;
    var worldX = (canvasX - viewer.scene.x) / viewer.scene.scaleX;
    var worldY = -(canvasY - viewer.scene.y) / viewer.scene.scaleY;

    if (!firstMapClick) {
      firstMapClick = { x: worldX, y: worldY };
      document.getElementById('map-status').textContent =
        'Position set (' + worldX.toFixed(2) + ', ' + worldY.toFixed(2) + ') — now click to set heading';
    } else {
      var dx = worldX - firstMapClick.x;
      var dy = worldY - firstMapClick.y;
      var theta = Math.atan2(dy, dx);
      if (mapMode === 'goal') publishGoal(firstMapClick.x, firstMapClick.y, theta);
      else publishInitialPose(firstMapClick.x, firstMapClick.y, theta);
      firstMapClick = null;
      document.getElementById('map-status').textContent = 'Done ✓';
      setTimeout(() => setMode('view'), 1500);
    }
  });

  // ─── External WebSocket (Task 2) ─────────────────────────
  let extWS = null;

  function toggleExtWS() {
    if (extWS && extWS.readyState === WebSocket.OPEN) {
      extWS.close();
      return;
    }
    var url = document.getElementById('ext-ws-url').value.trim();
    try {
      extWS = new WebSocket(url);
      extWS.onopen = () => {
        document.getElementById('ext-dot').className = 'dot connected';
        document.getElementById('ext-status').textContent = 'EXT WS CONNECTED';
        log('External WS connected: ' + url, 'ok');
      };
      // Expects JSON: { x, y, theta } or { pose: { x, y, theta } }
      extWS.onmessage = (event) => {
        try {
          var data = JSON.parse(event.data);
          var x = data.x ?? data.pose?.x ?? 0;
          var y = data.y ?? data.pose?.y ?? 0;
          var theta = data.theta ?? data.pose?.theta ?? 0;
          log('Ext WS pose → x:' + x.toFixed(2) + ' y:' + y.toFixed(2), 'ok');
          publishGoal(x, y, theta);
        } catch(e) {
          log('Ext WS parse error: ' + e.message, 'err');
        }
      };
      extWS.onerror = () => {
        log('External WS error', 'err');
        document.getElementById('ext-dot').className = 'dot';
        document.getElementById('ext-status').textContent = 'EXT WS ERROR';
      };
      extWS.onclose = () => {
        document.getElementById('ext-dot').className = 'dot warning';
        document.getElementById('ext-status').textContent = 'EXT WS IDLE';
        log('External WS closed', 'warn');
      };
    } catch(e) {
      log('Could not open WS: ' + e.message, 'err');
    }
  }

  // ─── Utility ─────────────────────────────────────────────
  function yawToQuaternion(yaw) {
    return { z: Math.sin(yaw / 2), w: Math.cos(yaw / 2) };
  }

  // Resize map on window resize
  window.addEventListener('resize', () => {
    var w = mapContainer.offsetWidth;
    var h = mapContainer.offsetHeight;
    viewer.renderer.resize(w, h);
  });

  log('Dashboard initialized', 'ok');
</script>
</body>
</html>
