<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/eventemitter2/lib/eventemitter2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/roslib/build/roslib.min.js"></script>
  <style>
    :root {
      --bg:#0a0d10;--surface:#111620;--border:#1e2a38;
      --accent:#00e5ff;--accent2:#ff6b35;--success:#00ff88;
      --warn:#ffd600;--text:#ccd6f6;--muted:#7a8fa6;
      --font-mono:'Share Tech Mono',monospace;--font-ui:'Rajdhani',sans-serif;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:var(--bg);color:var(--text);font-family:var(--font-ui);min-height:100vh}
    body::before{content:'';position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,229,255,.015) 2px,rgba(0,229,255,.015) 4px);pointer-events:none;z-index:9999}
    header{display:flex;align-items:center;justify-content:space-between;padding:14px 28px;background:var(--surface);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100}
    .logo{display:flex;align-items:center;gap:12px}
    .logo-icon{width:36px;height:36px;background:var(--accent);clip-path:polygon(50% 0%,100% 25%,100% 75%,50% 100%,0% 75%,0% 25%)}
    .logo h1{font-size:22px;font-weight:700;letter-spacing:3px;color:var(--accent);text-transform:uppercase}
    .logo span{font-size:11px;color:var(--muted);font-family:var(--font-mono);letter-spacing:2px;display:block}
    #conn-status{font-family:var(--font-mono);font-size:12px;display:flex;align-items:center;gap:12px}
    #login-btn{font-family:var(--font-mono);font-size:11px;letter-spacing:1px;padding:5px 12px;background:transparent;border:1px solid var(--accent);color:var(--accent);cursor:pointer;border-radius:2px;transition:all .15s}
    #login-btn:hover{background:var(--accent);color:var(--bg)}
    #login-btn.authed{border-color:var(--success);color:var(--success);pointer-events:none}
    #conn-dot{width:10px;height:10px;border-radius:50%;background:var(--muted);transition:background .3s}
    #conn-dot.connected{background:var(--success);animation:pulse 2s infinite}
    #conn-dot.error{background:var(--accent2)}
    @keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(0,255,136,.4)}50%{box-shadow:0 0 0 6px rgba(0,255,136,0)}}
    .main-grid{display:grid;grid-template-columns:1fr 420px;gap:16px;padding:16px 28px}
    .panel{background:var(--surface);border:1px solid var(--border);border-radius:4px;overflow:hidden}
    .panel-header{display:flex;align-items:center;justify-content:space-between;padding:10px 16px;border-bottom:1px solid var(--border);background:rgba(0,229,255,.04)}
    .panel-title{font-size:13px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--accent)}
    .panel-badge{font-family:var(--font-mono);font-size:10px;color:var(--muted);background:rgba(255,255,255,.05);padding:2px 8px;border-radius:2px}
    .map-panel{grid-column:1}
    #rviz-container{width:100%;height:500px;background:#060910;display:block;position:relative;overflow:hidden}
    #rviz-container > div{position:absolute!important;top:0!important;left:0!important;width:100%!important;height:100%!important;margin:0!important}
    #rviz-container canvas{display:block;width:100%!important;height:100%!important;margin:0!important}
    #vnc-overlay{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;background:rgba(6,9,16,.85);font-family:var(--font-mono);color:var(--muted);font-size:12px;z-index:10;transition:opacity .4s}
    #vnc-overlay.hidden{opacity:0;pointer-events:none}
    #vnc-spinner{width:28px;height:28px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    #vnc-status-text{color:var(--text);letter-spacing:1px}
    #vnc-reconnect{font-family:var(--font-ui);font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;padding:6px 14px;border:1px solid var(--accent2);color:var(--accent2);background:transparent;cursor:pointer;border-radius:2px;display:none}
    #vnc-reconnect:hover{background:var(--accent2);color:var(--bg)}
    .map-controls{display:flex;gap:8px;padding:10px 16px;border-top:1px solid var(--border);flex-wrap:wrap;align-items:center}
    .mode-btn{font-family:var(--font-ui);font-size:12px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;padding:7px 14px;border:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer;border-radius:2px;transition:all .15s}
    .mode-btn.active{border-color:var(--accent);color:var(--accent);background:rgba(0,229,255,.08)}
    .mode-btn:hover{border-color:var(--text);color:var(--text)}
    #map-mode-label{font-family:var(--font-mono);font-size:11px;color:var(--warn);margin-left:auto}
    .right-col{grid-column:2;display:flex;flex-direction:column;gap:16px}
    .pose-grid{display:grid;grid-template-columns:1fr 1fr;gap:1px;background:var(--border)}
    .pose-cell{background:var(--surface);padding:10px 14px}
    .pose-label{font-family:var(--font-mono);font-size:10px;color:var(--muted);letter-spacing:1px;margin-bottom:4px}
    .pose-value{font-family:var(--font-mono);font-size:18px;color:var(--accent)}
    .init-pose-form{padding:14px 16px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
    .init-pose-form input{background:var(--bg);border:1px solid var(--border);color:var(--text);font-family:var(--font-mono);font-size:13px;padding:7px 10px;border-radius:2px;width:100%}
    .init-pose-form input:focus{outline:none;border-color:var(--accent)}
    .init-pose-form input::placeholder{color:var(--muted)}
    .btn-primary{grid-column:1/-1;font-family:var(--font-ui);font-weight:700;font-size:13px;letter-spacing:2px;text-transform:uppercase;padding:10px;background:transparent;border:1px solid var(--accent);color:var(--accent);cursor:pointer;border-radius:2px;transition:all .15s}
    .btn-primary:hover{background:var(--accent);color:var(--bg)}
    .teleop-grid{display:grid;grid-template-columns:repeat(3,60px);grid-template-rows:repeat(3,60px);gap:6px;padding:16px;justify-content:center}
    .tele-btn{background:rgba(255,255,255,.03);border:1px solid var(--border);color:var(--text);font-size:20px;cursor:pointer;border-radius:3px;display:flex;align-items:center;justify-content:center;transition:all .1s;user-select:none}
    .tele-btn:hover{border-color:var(--accent);color:var(--accent);background:rgba(0,229,255,.08)}
    .tele-btn:active{background:var(--accent);color:var(--bg);border-color:var(--accent)}
    .tele-btn.stop{font-size:12px;font-family:var(--font-ui);font-weight:700;letter-spacing:1px;color:var(--accent2);border-color:var(--accent2)}
    .camera-panel{grid-column:1/-1}
    .camera-inner{padding:12px 16px}
    .camera-feed-wrap{flex:1;display:flex;flex-direction:column;min-width:0}
    .camera-feed-wrap video{width:100%;max-height:260px;object-fit:contain;border:1px solid var(--border);background:#000;display:block}
    .camera-feed-label{font-family:var(--font-mono);font-size:10px;color:var(--muted);padding:4px 0;letter-spacing:1px}
    .camera-inner{padding:12px 16px;display:flex;gap:12px}
    .ext-ws-form{padding:12px 16px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .ext-ws-form input{flex:1;min-width:180px;background:var(--bg);border:1px solid var(--border);color:var(--text);font-family:var(--font-mono);font-size:13px;padding:7px 10px;border-radius:2px}
    .ext-ws-form input:focus{outline:none;border-color:var(--accent2)}
    .btn-secondary{font-family:var(--font-ui);font-weight:700;font-size:12px;letter-spacing:1.5px;text-transform:uppercase;padding:8px 14px;background:transparent;border:1px solid var(--accent2);color:var(--accent2);cursor:pointer;border-radius:2px;transition:all .15s;white-space:nowrap}
    .btn-secondary:hover{background:var(--accent2);color:var(--bg)}
    #ext-ws-log{margin:0 16px 12px;font-family:var(--font-mono);font-size:11px;color:var(--muted);background:var(--bg);border:1px solid var(--border);padding:8px;max-height:80px;overflow-y:auto;border-radius:2px}
    .status-bar{display:flex;gap:24px;padding:8px 28px;background:var(--surface);border-top:1px solid var(--border);font-family:var(--font-mono);font-size:11px;color:var(--muted);flex-wrap:wrap}
    .status-bar span{display:flex;align-items:center;gap:6px}
    #toast{position:fixed;bottom:60px;right:28px;background:var(--success);color:var(--bg);font-family:var(--font-mono);font-size:12px;padding:10px 18px;border-radius:3px;opacity:0;transform:translateY(10px);transition:all .25s;pointer-events:none;z-index:200}
    #toast.show{opacity:1;transform:translateY(0)}
  </style>
</head>
<body>
<header>
  <div class="logo">
    <div class="logo-icon"></div>
    <div>
      <h1>Dashboard</h1>
      <span>ROBOTNIK RBWCH — NAVIGATION DASHBOARD</span>
    </div>
  </div>
  <div id="conn-status">
    <button id="login-btn" onclick="robotLogin()">LOGIN TO ROBOT</button>
    <div id="conn-dot"></div>
    <span id="conn-text">CONNECTING...</span>
  </div>
</header>

<div class="main-grid">
  <!-- MAP -->
  <div class="panel map-panel">
    <div class="panel-header">
      <span class="panel-title">Map &amp; Navigation</span>
      <span class="panel-badge">noVNC → wss:/rviz_web → rviz-vnc:5910</span>
    </div>
    <div id="rviz-container">
      <div id="vnc-overlay">
        <div id="vnc-spinner"></div>
        <span id="vnc-status-text">CONNECTING TO RVIZ VNC...</span>
        <button id="vnc-reconnect" onclick="connectVNC()">RECONNECT</button>
      </div>
    </div>
    <div class="map-controls" style="display:flex;align-items:center;justify-content:space-between">
      <span id="map-mode-label">&#9658; USE RVIZ TOOLS INSIDE THE VIEW TO SET GOALS</span>
      <button onclick="cancelGoal()" style="font-family:var(--font-mono);font-size:11px;letter-spacing:1px;padding:4px 12px;background:transparent;border:1px solid var(--accent2);color:var(--accent2);cursor:pointer;border-radius:2px;transition:all .15s" onmouseover="this.style.background='var(--accent2)';this.style.color='var(--bg)'" onmouseout="this.style.background='transparent';this.style.color='var(--accent2)'">&#9632; CANCEL GOAL</button>
    </div>
  </div>

  <!-- RIGHT COLUMN -->
  <div class="right-col">
    <!-- POSE -->
    <div class="panel">
      <div class="panel-header">
        <span class="panel-title">Robot Pose</span>
        <span class="panel-badge">/robot/amcl_pose</span>
      </div>
      <div class="pose-grid">
        <div class="pose-cell"><div class="pose-label">X (m)</div><div class="pose-value" id="poseX">--</div></div>
        <div class="pose-cell"><div class="pose-label">Y (m)</div><div class="pose-value" id="poseY">--</div></div>
        <div class="pose-cell"><div class="pose-label">YAW (deg)</div><div class="pose-value" id="poseTheta">--</div></div>
        <div class="pose-cell"><div class="pose-label">LIN VEL</div><div class="pose-value" id="poseLinVel">--</div></div>
        <div class="pose-cell"><div class="pose-label">ANG VEL</div><div class="pose-value" id="poseAngVel">--</div></div>
        <div class="pose-cell"><div class="pose-label">NAV STATE</div><div class="pose-value" id="navStatus" style="font-size:13px;color:var(--warn)">--</div></div>
      </div>
    </div>

    <!-- TASK 3: INITIAL POSE -->
    <div class="panel">
      <div class="panel-header">
        <span class="panel-title">Set Initial Pose</span>
        <span class="panel-badge">/robot/initialpose</span>
      </div>
      <div class="init-pose-form">
        <input id="init-x"   type="number" step="0.01" placeholder="X (m)"     value="0.0">
        <input id="init-y"   type="number" step="0.01" placeholder="Y (m)"     value="0.0">
        <input id="init-yaw" type="number" step="0.01" placeholder="Yaw (rad)" value="0.0">
        <button class="btn-primary" onclick="publishInitialPose()">PUBLISH INITIAL POSE</button>
      </div>
    </div>

    <!-- TASK 2: EXTERNAL WS -->
    <div class="panel">
      <div class="panel-header">
        <span class="panel-title">External Goal Source</span>
        <span class="panel-badge">WebSocket to goal topic</span>
      </div>
      <div class="ext-ws-form">
        <input id="ext-ws-url" type="text" placeholder="ws://host:port" value="ws://192.168.0.200:9091">
        <button class="btn-secondary" id="ext-ws-btn" onclick="toggleExternalWS()">CONNECT</button>
      </div>
      <div id="ext-ws-log">Awaiting external WebSocket connection...</div>
    </div>

    <!-- TELEOP -->
    <div class="panel">
      <div class="panel-header">
        <span class="panel-title">Teleop</span>
        <span class="panel-badge">/robot/web_teleop/cmd_vel</span>
      </div>
      <div class="teleop-grid">
        <div></div>
        <button class="tele-btn" onmousedown="startMoving(0.4,0)"  onmouseup="stopMoving()" onmouseleave="stopMoving()" ontouchstart="startMoving(0.4,0)"  ontouchend="stopMoving()">&#9650;</button>
        <div></div>
        <button class="tele-btn" onmousedown="startMoving(0,0.6)"  onmouseup="stopMoving()" onmouseleave="stopMoving()" ontouchstart="startMoving(0,0.6)"  ontouchend="stopMoving()">&#9664;</button>
        <button class="tele-btn stop" onmousedown="stopMoving()">STOP</button>
        <button class="tele-btn" onmousedown="startMoving(0,-0.6)" onmouseup="stopMoving()" onmouseleave="stopMoving()" ontouchstart="startMoving(0,-0.6)" ontouchend="stopMoving()">&#9654;</button>
        <div></div>
        <button class="tele-btn" onmousedown="startMoving(-0.4,0)" onmouseup="stopMoving()" onmouseleave="stopMoving()" ontouchstart="startMoving(-0.4,0)" ontouchend="stopMoving()">&#9660;</button>
        <div></div>
      </div>
      <p style="font-family:var(--font-mono);font-size:10px;color:var(--muted);text-align:center;padding-bottom:10px">Arrow keys also supported</p>
    </div>
  </div>

  <!-- CAMERA -->
  <div class="panel camera-panel">
    <div class="panel-header">
      <span class="panel-title">Cameras</span>
      <span class="panel-badge">WebRTC</span>
    </div>
    <div class="camera-inner">
      <div class="camera-feed-wrap">
        <video id="camera-front" autoplay playsinline muted></video>
        <div class="camera-feed-label">FRONT &nbsp;<span id="camera-front-status" style="color:var(--muted)">CONNECTING...</span></div>
      </div>
      <div class="camera-feed-wrap">
        <video id="camera-top" autoplay playsinline muted></video>
        <div class="camera-feed-label">TOP PTZ &nbsp;<span id="camera-top-status" style="color:var(--muted)">CONNECTING...</span></div>
      </div>
    </div>
  </div>
</div>

<div class="status-bar">
  <span>ROSBRIDGE <span id="sb-ros" style="color:var(--muted)">DISCONNECTED</span></span>
  <span>EXT-WS <span id="sb-ext" style="color:var(--muted)">DISCONNECTED</span></span>
  <span>MAP <span id="sb-map" style="color:var(--muted)">NO DATA</span></span>
  <span>LAST GOAL <span id="sb-goal" style="color:var(--muted)">--</span></span>
  <span style="margin-left:auto" id="sb-time">--</span>
</div>

<div id="toast"></div>

<script>
  // ── ROSBRIDGE ──
  var ROBOT_IP = '192.168.0.200';
  function robotLogin() {
    var popup = window.open('https://192.168.0.200/app','robot-login','width=520,height=620,left=200,top=100');
    var timer = setInterval(function() {
      if (!popup || popup.closed) {
        clearInterval(timer);
        document.getElementById('login-btn').textContent = 'LOGGED IN';
        document.getElementById('login-btn').className = 'authed';
        ros.connect('wss://' + ROBOT_IP + '/rosbridge');
        if (window._cameraPC) { window._cameraPC.close(); window._cameraPC = null; }
        connectCamera();
        if (window._vncRfb) { try { window._vncRfb.disconnect(); } catch(_) {} }
        connectVNC();
      }
    }, 500);
  }

  var ros = new ROSLIB.Ros({ url: 'wss://' + ROBOT_IP + '/ws' });

  ros.on('connection', function() {
    document.getElementById('conn-dot').className = 'connected';
    document.getElementById('conn-text').textContent = 'CONNECTED -- ' + ROBOT_IP;
    document.getElementById('sb-ros').textContent = 'CONNECTED';
    document.getElementById('sb-ros').style.color = 'var(--success)';
    initTopics();
  });
  ros.on('error', function() {
    document.getElementById('conn-dot').className = 'error';
    document.getElementById('conn-text').textContent = 'CONNECTION ERROR';
    document.getElementById('sb-ros').textContent = 'ERROR';
    document.getElementById('sb-ros').style.color = 'var(--accent2)';
  });
  ros.on('close', function() {
    document.getElementById('conn-dot').className = '';
    document.getElementById('conn-text').textContent = 'DISCONNECTED';
    document.getElementById('sb-ros').textContent = 'DISCONNECTED';
    document.getElementById('sb-ros').style.color = 'var(--muted)';
  });

  // ── TOPICS ──
  var cmdVelTopic, goalTopic, initialPoseTopic, rmsCancelTopic;

  function initTopics() {
    cmdVelTopic = new ROSLIB.Topic({ ros:ros, name:'/robot/web_teleop/cmd_vel', messageType:'geometry_msgs/Twist' });

    // TASK 1 - navigation goal
    goalTopic = new ROSLIB.Topic({ ros:ros, name:'/robot/rms/simple_goal', messageType:'geometry_msgs/PoseStamped' });
    rmsCancelTopic = new ROSLIB.Topic({ ros:ros, name:'/robot/rms/action/cancel', messageType:'actionlib_msgs/GoalID' });

    // TASK 3 - initial pose
    initialPoseTopic = new ROSLIB.Topic({ ros:ros, name:'/robot/initialpose', messageType:'geometry_msgs/PoseWithCovarianceStamped' });

    // AMCL pose display + map arrow
    new ROSLIB.Topic({ ros:ros, name:'/robot/amcl_pose', messageType:'geometry_msgs/PoseWithCovarianceStamped' })
      .subscribe(function(msg) {
        var p = msg.pose.pose;
        document.getElementById('poseX').textContent = p.position.x.toFixed(3);
        document.getElementById('poseY').textContent = p.position.y.toFixed(3);
        // Yaw from quaternion: atan2(2*(w*z+x*y), 1-2*(y*y+z*z))
        var siny = 2*(p.orientation.w*p.orientation.z + p.orientation.x*p.orientation.y);
        var cosy = 1 - 2*(p.orientation.y*p.orientation.y + p.orientation.z*p.orientation.z);
        var yawDeg = Math.atan2(siny, cosy) * 180 / Math.PI;
        document.getElementById('poseTheta').textContent = yawDeg.toFixed(1);

      });

    // Odometry
    new ROSLIB.Topic({ ros:ros, name:'/robot/robotnik_base_control/odom', messageType:'nav_msgs/Odometry' })
      .subscribe(function(msg) {
        document.getElementById('poseLinVel').textContent = msg.twist.twist.linear.x.toFixed(3);
        document.getElementById('poseAngVel').textContent = msg.twist.twist.angular.z.toFixed(3);
      });

    // Navigation state
    new ROSLIB.Topic({ ros:ros, name:'/robot/robot_local_control/NavigationComponent/state', messageType:'robotnik_msgs/State' })
      .subscribe(function(msg) {
        document.getElementById('navStatus').textContent = msg.state_description || msg.state || '--';
      });
  }

  function yawToQuaternion(yaw) {
    return { x:0, y:0, z:Math.sin(yaw/2), w:Math.cos(yaw/2) };
  }

  // ── MAP (RViz iframe - no ros2d needed) ──
  // Map is displayed via RViz VNC stream at /rviz_web

  // ── MAP CLICK MODES ──
  var mapMode = 'goal';
  function setMode(mode) {
    mapMode = mode;
    document.getElementById('btn-goal').classList.toggle('active', mode === 'goal');
    document.getElementById('btn-initpose').classList.toggle('active', mode === 'initpose');
    document.getElementById('map-mode-label').textContent =
      mode === 'goal' ? '> CLICK MAP TO SET GOAL POSE' : '> CLICK MAP TO SET INITIAL POSE';
  }

  // NOTE: Click-to-set-goal on the VNC canvas is not supported — the VNC stream
  // is a pixel mirror with no knowledge of the map coordinate frame. Use the
  // RViz "2D Nav Goal" tool inside the VNC view directly, or use the form fields below.

  // ── TASK 1: GOAL POSE ──
  function cancelGoal() {
    if (rmsCancelTopic) {
      rmsCancelTopic.publish(new ROSLIB.Message({}));
      showToast('Goal cancelled');
      document.getElementById('sb-goal').textContent = '--';
      document.getElementById('sb-goal').style.color = 'var(--muted)';
    } else {
      showToast('Not connected to ROS');
    }
  }

  function publishGoalPose(x, y, yaw) {
    if (!goalTopic) { showToast('Not connected to ROS'); return; }
    goalTopic.publish(new ROSLIB.Message({
      header: { frame_id:'robot_map', stamp:{ secs:Math.floor(Date.now()/1000), nsecs:(Date.now()%1000)*1e6 } },
      pose: { position:{ x:x, y:y, z:0 }, orientation:yawToQuaternion(yaw) }
    }));
    var label = 'x:' + x.toFixed(2) + ' y:' + y.toFixed(2);
    document.getElementById('sb-goal').textContent = label;
    document.getElementById('sb-goal').style.color = 'var(--warn)';
    showToast('Goal sent (' + x.toFixed(2) + ', ' + y.toFixed(2) + ')');
  }

  // ── TASK 3: INITIAL POSE ──
  function publishInitialPose() {
    if (!initialPoseTopic) { showToast('Not connected to ROS'); return; }
    var x   = parseFloat(document.getElementById('init-x').value)   || 0;
    var y   = parseFloat(document.getElementById('init-y').value)   || 0;
    var yaw = parseFloat(document.getElementById('init-yaw').value) || 0;
    initialPoseTopic.publish(new ROSLIB.Message({
      header: { frame_id:'robot_map', stamp:{ secs:Math.floor(Date.now()/1000), nsecs:(Date.now()%1000)*1e6 } },
      pose: {
        pose: { position:{ x:x, y:y, z:0 }, orientation:yawToQuaternion(yaw) },
        covariance: [0.25,0,0,0,0,0, 0,0.25,0,0,0,0, 0,0,0,0,0,0, 0,0,0,0,0,0, 0,0,0,0,0,0, 0,0,0,0,0,0.0685]
      }
    }));
    showToast('Initial pose set (' + x.toFixed(2) + ', ' + y.toFixed(2) + ')');
  }

  // ── TASK 2: EXTERNAL WEBSOCKET ──
  // Expects JSON: {"x": 1.0, "y": 2.0, "yaw": 0.0}
  var extWS = null;
  function logExt(msg) {
    var el = document.getElementById('ext-ws-log');
    el.textContent = '[' + new Date().toLocaleTimeString() + '] ' + msg + '\n' + el.textContent;
  }
  function toggleExternalWS() {
    if (extWS && extWS.readyState === WebSocket.OPEN) { extWS.close(); return; }
    var url = document.getElementById('ext-ws-url').value.trim();
    try { extWS = new WebSocket(url); } catch(e) { logExt('ERROR: ' + e.message); return; }
    extWS.onopen = function() {
      document.getElementById('ext-ws-btn').textContent = 'DISCONNECT';
      document.getElementById('sb-ext').textContent = 'CONNECTED';
      document.getElementById('sb-ext').style.color = 'var(--success)';
      logExt('Connected to ' + url);
    };
    extWS.onmessage = function(event) {
      try {
        var data = JSON.parse(event.data);
        if (data.x !== undefined && data.y !== undefined) {
          logExt('Pose received x:' + data.x + ' y:' + data.y + ' yaw:' + (data.yaw||0));
          publishGoalPose(parseFloat(data.x), parseFloat(data.y), parseFloat(data.yaw||0));
        } else { logExt('Unknown format: ' + event.data); }
      } catch(e) { logExt('Parse error: ' + e.message); }
    };
    extWS.onerror = function() { logExt('Error'); document.getElementById('sb-ext').style.color='var(--accent2)'; };
    extWS.onclose = function() {
      document.getElementById('ext-ws-btn').textContent = 'CONNECT';
      document.getElementById('sb-ext').textContent = 'DISCONNECTED';
      document.getElementById('sb-ext').style.color = 'var(--muted)';
      logExt('Disconnected');
    };
  }

  // ── TELEOP ──
  var teleopInterval = null;
  function startMoving(linVel, angVel) {
    if (teleopInterval) clearInterval(teleopInterval);
    teleopInterval = setInterval(function() {
      if (!cmdVelTopic) return;
      cmdVelTopic.publish(new ROSLIB.Message({ linear:{x:linVel,y:0,z:0}, angular:{x:0,y:0,z:angVel} }));
    }, 50);
  }
  function stopMoving() {
    if (teleopInterval) clearInterval(teleopInterval);
    teleopInterval = null;
    if (cmdVelTopic) cmdVelTopic.publish(new ROSLIB.Message({ linear:{x:0,y:0,z:0}, angular:{x:0,y:0,z:0} }));
  }
  // Stop on mouseup anywhere on the page — ensures release is always caught
  document.addEventListener('mouseup', stopMoving);
  document.addEventListener('touchend', stopMoving);
  var keysDown = {};
  document.addEventListener('keydown', function(e) {
    if (keysDown[e.key]) return; keysDown[e.key] = true;
    if      (e.key==='ArrowUp')    startMoving(0.4,0);
    else if (e.key==='ArrowDown')  startMoving(-0.4,0);
    else if (e.key==='ArrowLeft')  startMoving(0,0.6);
    else if (e.key==='ArrowRight') startMoving(0,-0.6);
  });
  document.addEventListener('keyup', function(e) {
    delete keysDown[e.key];
    if (['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)) stopMoving();
  });

  // ── RVIZ VNC (noVNC) ──
  // noVNC is loaded as an ES module separately below
  // connectVNC() is called from that module once RFB is available
  window._vncRfb = null;

  // ── WEBRTC CAMERAS ────────────────────────────────────────────────────────
  async function connectCamera() {
    var frontVideo  = document.getElementById('camera-front');
    var topVideo    = document.getElementById('camera-top');
    var frontStatus = document.getElementById('camera-front-status');
    var topStatus   = document.getElementById('camera-top-status');

    try {
      var pc = new RTCPeerConnection({ iceServers: [] });
      window._cameraPC = pc;

      pc.addTransceiver('video', { direction: 'recvonly' }); // mid:0 thermal
      pc.addTransceiver('video', { direction: 'recvonly' }); // mid:1 top ptz
      pc.addTransceiver('video', { direction: 'recvonly' }); // mid:2 front
      pc.addTransceiver('audio', { direction: 'sendrecv' }); // mid:3
      pc.createDataChannel('data');                          // mid:4

      var pendingTracks = new Map();

      pc.ontrack = function(event) {
        if (event.track.kind === 'video') {
          pendingTracks.set(event.transceiver, event.track);
          tryAttach();
        }
      };

      function tryAttach() {
        pc.getTransceivers().forEach(function(tc) {
          if (!pendingTracks.has(tc)) return;
          var track = pendingTracks.get(tc);
          if (tc.mid === '2') {
            frontVideo.srcObject = new MediaStream([track]);
            frontStatus.textContent = 'LIVE';
            frontStatus.style.color = 'var(--success)';
          }
          if (tc.mid === '1') {
            topVideo.srcObject = new MediaStream([track]);
            topStatus.textContent = 'LIVE';
            topStatus.style.color = 'var(--success)';
          }
        });
      }

      pc.oniceconnectionstatechange = function() {
        if (pc.iceConnectionState === 'failed' || pc.iceConnectionState === 'disconnected') {
          frontStatus.textContent = 'DISCONNECTED';
          frontStatus.style.color = 'var(--accent2)';
          topStatus.textContent   = 'DISCONNECTED';
          topStatus.style.color   = 'var(--accent2)';
        }
      };

      var offer = await pc.createOffer();
      await pc.setLocalDescription(offer);

      var clientId = Math.random().toString(36).substring(2, 13);
      var res = await fetch('https://192.168.0.200/webrtc/offer', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          client_id: clientId, sdp: offer.sdp,
          target_audio: '', target_video: 'all',
          token: 'token', type: 'offer'
        })
      });

      if (!res.ok) throw new Error('Offer failed: HTTP ' + res.status);
      var answer = await res.json();
      await pc.setRemoteDescription({ type: 'answer', sdp: answer.sdp });
      tryAttach();

    } catch(e) {
      console.error('[Camera]', e);
      document.getElementById('camera-front-status').textContent = 'ERROR: ' + e.message;
      document.getElementById('camera-front-status').style.color = 'var(--accent2)';
    }
  }

  connectCamera();

  // ── CLOCK + TOAST ──
  setInterval(function() { document.getElementById('sb-time').textContent = new Date().toLocaleTimeString(); }, 1000);
  var toastTimer = null;
  function showToast(msg) {
    var t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    if (toastTimer) clearTimeout(toastTimer);
    toastTimer = setTimeout(function() { t.classList.remove('show'); }, 2500);
  }
</script>

<script type="module">
(async function() {
  let RFB;
  try {
    const mod = await import('https://cdn.jsdelivr.net/npm/@novnc/novnc@1.4.0/core/rfb.js');
    RFB = mod.default;
  } catch(importErr) {
    console.error('[VNC] noVNC import failed:', importErr);
    document.getElementById('vnc-status-text').textContent = 'noVNC LOAD ERROR';
    document.getElementById('vnc-spinner').style.display   = 'none';
    document.getElementById('vnc-reconnect').style.display = 'inline-block';
    return;
  }
  const VNC_URL = 'wss://192.168.0.200/rviz_web';
  const VNC_PASSWORD = 'RXN82ybVZbMsyriB';
  const container  = document.getElementById('rviz-container');
  const overlay    = document.getElementById('vnc-overlay');
  const statusText = document.getElementById('vnc-status-text');
  const spinner    = document.getElementById('vnc-spinner');
  const reconnBtn  = document.getElementById('vnc-reconnect');
  function vncLog(msg, level) { console[level || 'log']('[VNC]', msg); statusText.textContent = msg; }
  function setVncStatus(msg, showSpinner, showReconnect) {
    vncLog(msg);
    spinner.style.display   = showSpinner   ? 'block' : 'none';
    reconnBtn.style.display = showReconnect ? 'inline-block' : 'none';
    overlay.classList.remove('hidden');
  }
  function probeWebSocket() {
    return new Promise((resolve) => {
      let ws;
      try { ws = new WebSocket(VNC_URL); ws.binaryType = 'arraybuffer'; }
      catch(e) { resolve({ ok: false, reason: e.message }); return; }
      const timer = setTimeout(() => { ws.close(); resolve({ ok: false, reason: 'Timed out' }); }, 10000);
      ws.onopen  = () => { clearTimeout(timer); ws.close(1000, 'probe done'); resolve({ ok: true }); };
      ws.onerror = () => { clearTimeout(timer); resolve({ ok: false, reason: 'WebSocket error' }); };
      ws.onclose = (e) => { clearTimeout(timer); if (e.code !== 1000) resolve({ ok: false, reason: 'Closed early code ' + e.code }); };
    });
  }
  window.connectVNC = async function connectVNC() {
    if (window._vncRfb) { try { window._vncRfb.disconnect(); } catch(_) {} window._vncRfb = null; }
    setVncStatus('PROBING WebSocket...', true, false);
    const probe = await probeWebSocket();
    if (!probe.ok) {
      setVncStatus('WS PROBE FAILED: ' + probe.reason, false, true);
      document.getElementById('sb-map').textContent = 'WS FAILED';
      document.getElementById('sb-map').style.color = 'var(--accent2)';
      return;
    }
    setVncStatus('WebSocket OK - starting RFB handshake...', true, false);
    let rfb;
    try { rfb = new RFB(container, VNC_URL, { credentials: { password: VNC_PASSWORD } }); }
    catch(e) { setVncStatus('RFB error: ' + e.message, false, true); return; }
    rfb.viewOnly = false; rfb.scaleViewport = true; rfb.clipViewport = true;
    rfb.resizeSession = false; rfb.background = '#060910';
    rfb.addEventListener('connect', () => {
      vncLog('RFB connected'); overlay.classList.add('hidden');
      document.getElementById('sb-map').textContent = 'VNC LIVE';
      document.getElementById('sb-map').style.color = 'var(--success)';
    });
    rfb.addEventListener('disconnect', (e) => {
      const d = e.detail || {};
      setVncStatus(d.clean ? 'VNC DISCONNECTED' : 'VNC LOST: ' + (d.reason || 'unexpected'), false, true);
      document.getElementById('sb-map').textContent = 'VNC LOST';
      document.getElementById('sb-map').style.color = 'var(--accent2)';
    });
    rfb.addEventListener('credentialsrequired', () => { rfb.sendCredentials({ password: VNC_PASSWORD }); });
    rfb.addEventListener('securityfailure', (e) => {
      setVncStatus('VNC AUTH FAILED: ' + ((e.detail && e.detail.reason) || 'unknown'), false, true);
    });
    window._vncRfb = rfb;
  };
  connectVNC();
})();
</script>
</body>
</html>
